<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Caro Battle - Sảnh Chờ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="page-auth" class="auth-container">
        
        <div class="auth-card" id="form-login">
            <div class="logo-wrapper">
                <div class="logo-icon">
                    <span class="x-shape">X</span>
                    <span class="o-shape">O</span>
                </div>
                <h1 class="logo-text">Caro <span>Battle</span></h1>
            </div>

            <h2 class="auth-subtitle">Đăng nhập để chiến đấu!</h2>
            
            <div class="input-group-modern">
                <i class="fas fa-user"></i>
                <input type="text" id="username" placeholder="Tên tài khoản của bạn">
            </div>
            
            <div class="input-group-modern">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="Mật khẩu">
            </div>

            <button class="btn btn-gradient" onclick="handleLogin()">
                <span>VÀO GAME NGAY</span>
                <i class="fas fa-sign-in-alt"></i>
            </button>

            <div class="auth-footer">
                Chưa có tài khoản? <a href="javascript:void(0)" onclick="toggleAuth(false)">Đăng ký miễn phí</a>
            </div>
        </div>

        <div class="auth-card hidden" id="form-reg">
            <div class="logo-wrapper">
                <div class="logo-icon">
                    <span class="x-shape">X</span>
                    <span class="o-shape">O</span>
                </div>
                <h1 class="logo-text">Caro <span>Battle</span></h1>
            </div>

            <h2 class="auth-subtitle">Đăng ký nhanh trong 3 giây</h2>

            <div class="input-group-modern">
                <i class="fas fa-user-plus"></i>
                <input type="text" id="reg-user" placeholder="Nhập tên tài khoản mới">
            </div>
            
            <div class="input-group-modern">
                <i class="fas fa-key"></i>
                <input type="password" id="reg-pass" placeholder="Nhập mật khẩu mới">
            </div>

            <button class="btn btn-gradient" onclick="handleRegister()">
                <span>HOÀN TẤT ĐĂNG KÝ</span>
                <i class="fas fa-check-circle"></i>
            </button>

            <div class="auth-footer">
                Đã có tài khoản rồi? <a href="javascript:void(0)" onclick="toggleAuth(true)">Quay lại đăng nhập</a>
            </div>
        </div>

    </div>

    <div id="page-lobby" class="hidden">
        <nav class="navbar">
            <div style="font-weight:800; color:var(--primary); font-size:22px;">Caro Battle</div>
            <div style="font-size:14px; font-weight:600;">Chào, <span id="player-name"></span> 
                <button class="btn btn-outline" style="color:red; margin-left:10px; padding:5px 10px;" onclick="handleLogout()">Thoát</button>
            </div>
        </nav>
        <div class="lobby-layout">
            <div class="card">
                <h3><i class="fas fa-users" style="color:#3b82f6;"></i> Người chơi Online</h3>
                
                <div id="online-list" style="padding: 20px 0;">
                    <div style="text-align: center; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px;"></i>
                        <p>Đang tải danh sách...</p>
                    </div>
                </div>
            </div>
            
            <div class="profile-col">
                <div class="card" style="text-align: center; padding: 30px;">
                    <div style="width:80px; height:80px; background:#e2e8f0; border-radius:50%; margin:0 auto 10px; display:flex; justify-content:center; align-items:center; font-size:30px; color:#94a3b8;"><i class="fas fa-user"></i></div>
                    <h3 id="display-user"></h3>
                    <p style="font-size:12px; color:green; font-weight:600;">Đang online</p>
                </div>
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><i class="fas fa-history" style="color:#64748b;"></i><b> Lịch sử đấu</b></div>
                    <button class="btn btn-outline" onclick="openHistory()">Xem chi tiết</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-challenge" class="modal-overlay hidden">
        <div class="confirm-modal">
            <p>Người chơi <b id="opp-text" style="color: var(--primary);">...</b> muốn thách đấu!</p>
            <div style="display:flex; align-items:center; justify-content:center; gap:35px; margin:25px 0;">
                <div style="width:60px; height:60px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:25px; color:#cbd5e1;"><i class="fas fa-user"></i></div>
                <div style="font-weight:900; color:#cbd5e1; font-size:24px;">VS</div>
                <div style="width:60px; height:60px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:25px; color:#cbd5e1;"><i class="fas fa-user"></i></div>
            </div>
            <div style="display:flex; gap:10px; justify-content: center;">
                <button class="btn btn-primary" style="background:#2ecc71; width:auto;" onclick="acceptChallenge()">CHẤP NHẬN</button>
                <button class="btn btn-red-solid" style="background:#ef4444;" onclick="closeModal()">TỪ CHỐI</button>
            </div>
        </div>
    </div>

    <div id="modal-history" class="modal-overlay hidden">
        <div class="history-modal-content">
            <div class="history-header">
                <h2>Lịch sử Trận đấu</h2>
                <button class="btn" style="background:transparent; color:#64748b;" onclick="closeHistory()">
                    <i class="fas fa-times" style="font-size: 20px;"></i>
                </button>
            </div>

            <div class="history-stats">
                <div class="stat-box">
                    <span class="stat-val val-blue" id="st-total">0</span>
                    <span class="stat-label">Tổng trận</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val val-green" id="st-win">0</span>
                    <span class="stat-label">Thắng</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val val-red" id="st-loss">0</span>
                    <span class="stat-label">Thua</span>
                </div>
                <div class="stat-box">
                    <span class="stat-val val-purple" id="st-rate">0%</span>
                    <span class="stat-label">Tỷ lệ thắng</span>
                </div>
            </div>

            <div class="history-table-header">
                <div>Ngày giờ</div>
                <div>Đối thủ</div>
                <div>Kết quả</div>
                <div>Trạng thái</div>
            </div>

            <div id="history-list-container" class="history-list">
                </div>
        </div>
    </div>

    <div id="screen-loading" class="loading-screen modal-overlay hidden" style="background: var(--bg-light); z-index:9999;">
        <div style="text-align:center;">
            <div style="font-weight:800; font-size:18px;">Đang kết nối vào phòng...</div>
            <div id="timer" style="font-size:100px; font-weight:900; color:#ef4444; margin:20px 0;">3</div>
        </div>
    </div>

    <script>
        let lobbySocket = null;
        let currentUser = null;
        let currentOpponent = null; 

        // 1. KHỞI TẠO TRANG
        window.onload = () => { 
            const savedUser = localStorage.getItem('isLogged');
            if(savedUser) {
                currentUser = savedUser;
                showPage('page-lobby');
                connectLobby(savedUser); 
            } else {
                showPage('page-auth');
            }
        }

        // 2. KẾT NỐI WEBSOCKET SẢNH CHỜ
        function connectLobby(username) {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.host; 
            
            lobbySocket = new WebSocket(`${protocol}://${host}/ws/lobby/${username}`);
            
            lobbySocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === "online_list") {
                    renderOnlineList(data.users);
                } 
                else if (data.type === "challenge_received") {
                    currentOpponent = data.from;
                    document.getElementById('opp-text').innerText = data.from;
                    document.getElementById('modal-challenge').classList.remove('hidden');
                } 
                else if (data.type === "start_game") {
                    startGameSequence(data.room); 
                }
            };
        }

        // 3. HIỂN THỊ DANH SÁCH ONLINE
        function renderOnlineList(users) {
            const listDiv = document.getElementById('online-list');
            let html = '';
            
            users.forEach(user => {
                if (user !== currentUser) { 
                    html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 10px; border-bottom:1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="avt-circle" style="width:35px; height:35px; background:#e2e8f0; border-radius:50%; display:flex; justify-content:center; align-items:center; color:#64748b;"><i class="fas fa-user"></i></div>
                            <b style="color:#334155;">${user}</b>
                        </div>
                        <button class="btn btn-outline" style="width:auto; padding:5px 15px; font-size:13px; border-radius:20px;" onclick="sendChallenge('${user}')">
                            <i class="fas fa-bolt"></i> Thách đấu
                        </button>
                    </div>`;
                }
            });

            if (html === '') {
                html = `<div style="text-align: center; color: #94a3b8; padding: 20px;">
                            <i class="fas fa-coffee" style="font-size: 30px; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>Chưa có ai khác online</p>
                        </div>`;
            }
            
            listDiv.innerHTML = html;
        }

        // 4. GỬI LỜI MỜI
        window.sendChallenge = function(targetUser) {
            if (!lobbySocket) return;
            lobbySocket.send(JSON.stringify({
                action: "challenge_request",
                target: targetUser
            }));
            alert(`Đã gửi lời mời tới ${targetUser}. Vui lòng chờ...`);
        }

        // 5. CHẤP NHẬN LỜI MỜI
        window.acceptChallenge = function() {
            lobbySocket.send(JSON.stringify({
                action: "challenge_accept",
                to: currentOpponent
            }));
            closeModal();
        }

        // 6. CHUYỂN TRANG VÀO GAME
        function startGameSequence(roomId) {
            document.getElementById('screen-loading').classList.remove('hidden'); 
            let t = 3; 
            let i = setInterval(() => { 
                t--; 
                document.getElementById('timer').innerText = t; 
                if(t <= 0) { 
                    clearInterval(i); 
                    const parts = roomId.split('_VS_');
                    const opponentName = (parts[0] === currentUser) ? parts[1] : parts[0];
                    window.location.href = `game.html?room=${roomId}&opp=${opponentName}`; 
                } 
            }, 1000);
        }

        //CÁC HÀM XỬ LÝ AUTH
        function toggleAuth(showLogin) { 
            const loginForm = document.getElementById('form-login');
            const regForm = document.getElementById('form-reg');
            if (showLogin) { loginForm.classList.remove('hidden'); regForm.classList.add('hidden'); } 
            else { loginForm.classList.add('hidden'); regForm.classList.remove('hidden'); }
            document.querySelectorAll('input').forEach(i => i.value = ""); 
        }

        function handleLogin() { 
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const savedU = localStorage.getItem('reg_u');
            const savedP = localStorage.getItem('reg_p');
            
            if (!savedU) {
                localStorage.setItem('isLogged', u); 
                currentUser = u;
                showPage('page-lobby');
                connectLobby(u);
                return;
            }
            
            if(u === savedU && p === savedP) { 
                localStorage.setItem('isLogged', u); 
                currentUser = u;
                showPage('page-lobby');
                connectLobby(u); 
            } else {
                alert("Sai tên đăng nhập hoặc mật khẩu");
            }
        }

        function handleRegister() { 
            const u = document.getElementById('reg-user').value;
            const p = document.getElementById('reg-pass').value; 
            if(!u || !p) return alert("Vui lòng điền đầy đủ!"); 
            localStorage.setItem('reg_u', u); localStorage.setItem('reg_p', p); 
            alert("Đăng ký thành công!"); toggleAuth(true); 
        }

        function handleLogout() { 
            localStorage.removeItem('isLogged'); 
            location.reload(); 
        }

        function showPage(id) { 
            document.querySelectorAll('body > div').forEach(p => p.classList.add('hidden')); 
            document.getElementById(id).classList.remove('hidden'); 
            if(currentUser) { 
                document.getElementById('player-name').innerText = currentUser; 
                document.getElementById('display-user').innerText = currentUser; 
            } 
        }
        function closeModal() { document.getElementById('modal-challenge').classList.add('hidden'); }

        //LOGIC LỊCH SỬ ĐẤU
        async function openHistory() {
            if (!currentUser) return;
            
            // Hiện Modal trước
            document.getElementById('modal-history').classList.remove('hidden');
            document.getElementById('history-list-container').innerHTML = 
                '<div style="text-align:center; padding:20px;">Đang tải dữ liệu...</div>';

            try {
                // Gọi API lấy lịch sử từ Server
                const res = await fetch(`/api/history/${currentUser}`);
                const data = await res.json();
                
                renderHistoryUI(data);
            } catch (err) {
                console.error(err);
                document.getElementById('history-list-container').innerText = "Lỗi tải dữ liệu!";
            }
        }

        function closeHistory() {
            document.getElementById('modal-history').classList.add('hidden');
        }

        function renderHistoryUI(matches) {
            // 1. Tính toán thống kê
            const total = matches.length;
            const wins = matches.filter(m => m.winner === currentUser).length;
            const losses = total - wins; 
            const rate = total === 0 ? 0 : Math.round((wins / total) * 100);

            document.getElementById('st-total').innerText = total;
            document.getElementById('st-win').innerText = wins;
            document.getElementById('st-loss').innerText = losses;
            document.getElementById('st-rate').innerText = rate + "%";

            // 2. Render danh sách
            const listDiv = document.getElementById('history-list-container');
            if (total === 0) {
                listDiv.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#94a3b8;">
                        <i class="fas fa-gamepad" style="font-size:40px; margin-bottom:10px;"></i>
                        <p>Chưa có lịch sử trận đấu</p>
                    </div>`;
                return;
            }

            let html = '';
            matches.forEach(m => {
                const isWin = m.winner === currentUser;
                const opponent = (m.player_x === currentUser) ? m.player_o : m.player_x;
                const resultTag = isWin 
                    ? `<span class="tag tag-win">THẮNG</span>` 
                    : `<span class="tag tag-lose">THUA</span>`;
                
                html += `
                <div class="history-item">
                    <div>${m.timestamp}</div>
                    <div style="font-weight:700;">${opponent}</div>
                    <div>${resultTag}</div>
                    <div style="font-size:12px; color:#64748b;">Hoàn thành</div>
                </div>`;
            });
            listDiv.innerHTML = html;
        }
    </script>
</body>
</html>